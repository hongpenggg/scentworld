<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScentWorld - Fragrance Memory Painter</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --sidebar-width: 300px;
            --sidebar-gap: 20px;
            --gold: #D4AF37;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: #2c2c2c;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }
        .squircle { border-radius: 24px; }

        .nav-link {
            position: relative;
            padding: 4px 8px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            z-index: 10;
        }
        .nav-link-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background-color: rgba(212, 175, 55, 0.3);
            transform: skewX(-20deg);
            z-index: -1;
            transition: height 0.3s ease, background-color 0.3s ease;
        }
        .nav-link:hover .nav-link-bg {
            height: 100%;
            background-color: rgba(212, 175, 55, 0.5);
        }

        #sidebar {
            position: fixed;
            top: 100px;
            left: 20px;
            bottom: 100px;
            width: var(--sidebar-width);
            z-index: 40;
            transform: translateX(0);
            opacity: 1;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #sidebar.closed {
            transform: translateX(calc(-1 * var(--sidebar-width) - 40px));
            opacity: 0;
            pointer-events: none;
        }

        #sidebar-toggle {
            position: fixed;
            top: 100px;
            z-index: 41;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
        }
        
        #sidebar-toggle.open-pos {
            left: calc(20px + var(--sidebar-width) + 15px);
        }
        #sidebar-toggle.closed-pos {
            left: 30px;
        }

        #sidebar-toggle:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: rgba(255,255,255, 0.9);
        }

        #main-container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-top: 100px;
            padding-bottom: 40px;
        }

        #main-container.with-sidebar {
            padding-left: calc(var(--sidebar-width) + 60px);
            padding-right: 40px;
        }
        #main-container.with-sidebar .layout-wrapper {
            flex-direction: column;
            align-items: center;
        }
        #main-container.with-sidebar .pyramid-section { width: 100%; max-width: 600px; }
        #main-container.with-sidebar .memory-section { width: 100%; max-width: 600px; margin-top: 2rem; }

        #main-container.no-sidebar {
            padding-left: 40px;
            padding-right: 40px;
        }
        #main-container.no-sidebar .layout-wrapper {
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            gap: 4rem;
            flex-wrap: wrap;
        }
        #main-container.no-sidebar .pyramid-section { width: 45%; min-width: 320px; }
        #main-container.no-sidebar .memory-section { width: 45%; min-width: 320px; margin-top: 0; }

        body.mode-select #selection-overlay {
            opacity: 1;
            pointer-events: auto;
            backdrop-filter: blur(8px);
        }
        body.mode-select .drop-zone {
            z-index: 60;
            background-color: rgba(255, 255, 255, 0.95);
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
            cursor: pointer;
            animation: pulse-gold 2s infinite;
        }
        body.mode-select .drop-zone .empty-label { color: #888; }
        body.mode-select #sidebar, 
        body.mode-select header, 
        body.mode-select footer { 
            filter: blur(4px); 
            pointer-events: none; 
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        .note-chip {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .note-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .drop-zone {
            transition: all 0.3s ease;
            position: relative;
        }
        .drop-zone.drag-over {
            background-color: #f0fdf4;
            border-color: #4ade80;
            transform: scale(1.02);
        }

        #splash-screen {
            position: fixed; inset: 0; background: #fdfbfb; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        .splash-hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        #music-btn {
            position: fixed; bottom: 24px; right: 24px; z-index: 50;
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        #music-btn:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }

        .family-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }

    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="assets/piano.mp3" type="audio/mpeg">
    </audio>

    <div id="selection-overlay" class="fixed inset-0 bg-black/10 opacity-0 pointer-events-none z-50 transition-all duration-300" onclick="cancelSelection()">
        <div class="absolute top-10 left-0 right-0 text-center text-white text-xl font-serif italic drop-shadow-md">Select a layer to place the note...</div>
    </div>

    <div id="splash-screen">
        <h1 class="text-5xl md:text-7xl font-serif italic text-gray-800 mb-4 tracking-wide">ScentWorld</h1>
        <p class="text-gray-400 mb-10 font-light tracking-[0.3em] uppercase text-xs">The Olfactory Playground</p>
        <button onclick="enterWorld()" class="px-10 py-3 bg-gray-900 text-white rounded-full font-serif italic hover:bg-gray-800 transition-all transform hover:scale-105 shadow-xl">
            Enter
        </button>
    </div>

    <header class="fixed top-0 left-0 right-0 h-20 glass-panel z-40 flex justify-between items-center px-6 md:px-12 border-b-0 rounded-b-2xl mx-4 mt-2">
        <div class="text-2xl font-serif italic font-bold text-gray-800">ScentWorld</div>
        <nav class="flex gap-8">
            <a href="index.html" class="nav-link text-sm font-bold text-gray-700">
                Home
                <div class="nav-link-bg"></div>
            </a>
            <a href="gemini.html" class="nav-link text-sm font-bold text-gray-700">
                ScentWorld AI
                <div class="nav-link-bg"></div>
            </a>
        </nav>
    </header>

    <div id="sidebar-toggle" class="glass-panel open-pos" onclick="toggleSidebar()">
        <i data-lucide="panel-left-close" class="text-gray-600 transition-transform duration-300"></i>
    </div>

    <aside id="sidebar" class="glass-panel squircle flex flex-col overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-white/40">
            <h2 class="font-bold text-gray-500 tracking-widest uppercase text-[10px]">Fragrance Library</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-3 custom-scroll space-y-2" id="notes-container"></div>
        <div class="p-3 bg-white/40 text-[9px] text-gray-400 border-t border-gray-100 text-center uppercase tracking-widest">
            Select or Drag
        </div>
    </aside>

    <div id="main-container" class="with-sidebar">
        
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl md:text-5xl text-gray-800 mb-2 serif italic">Compose Your Memory</h1>
            <p class="text-gray-500 font-light text-xs uppercase tracking-widest">Layer notes to reveal the scene</p>
        </div>

        <div class="layout-wrapper flex w-full max-w-7xl mx-auto transition-all duration-500">

            <div class="pyramid-section flex flex-col items-center gap-3 transition-all duration-500">
                
                <div class="w-full flex flex-col items-center">
                    <div class="text-[9px] uppercase tracking-widest text-gray-400 mb-1">Top Notes</div>
                    <div class="w-2/3 min-h-[70px] glass-panel squircle p-2 flex flex-wrap justify-center gap-2 items-center drop-zone border-2 border-dashed border-gray-300 transition-all" 
                         ondrop="drop(event, 'top')" ondragover="allowDrop(event)" onclick="handleLayerClick('top')" id="zone-top">
                         <span class="text-gray-300 text-[10px] font-bold uppercase tracking-wide empty-label pointer-events-none">First Impression</span>
                    </div>
                </div>

                <div class="w-full flex flex-col items-center">
                    <div class="text-[9px] uppercase tracking-widest text-pink-300 mb-1">Heart Notes</div>
                    <div class="w-5/6 min-h-[80px] glass-panel squircle p-2 flex flex-wrap justify-center gap-2 items-center drop-zone border-2 border-dashed border-gray-300 transition-all" 
                         ondrop="drop(event, 'heart')" ondragover="allowDrop(event)" onclick="handleLayerClick('heart')" id="zone-heart">
                         <span class="text-gray-300 text-[10px] font-bold uppercase tracking-wide empty-label pointer-events-none">The Emotion</span>
                    </div>
                </div>

                <div class="w-full flex flex-col items-center">
                    <div class="text-[9px] uppercase tracking-widest text-amber-600 mb-1">Base Notes</div>
                    <div class="w-full min-h-[90px] glass-panel squircle p-2 flex flex-wrap justify-center gap-2 items-center drop-zone border-2 border-dashed border-gray-300 transition-all" 
                         ondrop="drop(event, 'base')" ondragover="allowDrop(event)" onclick="handleLayerClick('base')" id="zone-base">
                         <span class="text-gray-300 text-[10px] font-bold uppercase tracking-wide empty-label pointer-events-none">The Memory</span>
                    </div>
                </div>

                <button onclick="resetPyramid()" class="mt-4 text-[10px] uppercase tracking-widest text-gray-400 hover:text-red-400 transition-colors">
                    Reset Canvas
                </button>
            </div>

            <div class="memory-section transition-all duration-500">
                <div class="relative w-full aspect-[16/9] md:aspect-[21/9] bg-gray-900 text-gray-100 flex items-center justify-center p-8 md:p-12 shadow-2xl squircle overflow-hidden group">
                    <div id="scene-bg" class="absolute inset-0 opacity-30 bg-gradient-to-br from-gray-800 via-black to-gray-900 transition-all duration-1000"></div>
                    <div class="relative z-10 text-center max-w-xl">
                        <h3 class="text-2xl md:text-3xl font-serif mb-4 text-white/90 italic tracking-wide transition-all duration-700" id="scene-title">The Void</h3>
                        <div class="h-px w-10 bg-white/20 mx-auto mb-4"></div>
                        <p class="text-sm text-gray-400 leading-relaxed font-light transition-all duration-700" id="scene-desc">
                            The air is still. The canvas is blank. Add a note to begin the memory.
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="bg-white border-t border-gray-200 w-full py-12 mt-auto z-10">
        <div class="max-w-7xl mx-auto px-6 md:px-12">
            <h4 class="font-serif italic text-2xl text-gray-800 mb-2">ScentWorld</h4>
            <p class="text-sm font-bold text-gray-600 mb-2">&copy; Hongpeng Wei, 2026.</p>
            <p class="text-[10px] text-gray-400">The music on this site is JANACEK Sonata 1.X.1905, copyright of Charlie Albright, Free Music Archive.</p>
        </div>
    </footer>

    <button onclick="toggleMusic()" id="music-btn" class="glass-panel text-gray-600">
        <div id="music-icon-wrapper" class="relative">
            <i data-lucide="music" width="20"></i>
            <div id="music-strike" class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-600 transform -rotate-45 transition-opacity duration-300"></div>
        </div>
    </button>

    <script>
        const families = {
            "Floral": ["Rose", "Jasmine", "Lavender", "Ylang Ylang", "Tuberose", "Iris", "Violet", "Lily-of-the-valley", "Gardenia", "Freesia", "Magnolia", "Osmanthus", "Peony", "Lilac", "Carnation", "Heliotrope", "Orange Blossom", "Neroli", "Chamomile", "Geranium", "Honeysuckle", "Mimosa", "Narcissus", "Hyacinth", "Lotus", "Water Lily", "Frangipani", "Plumeria", "Wisteria", "Begonia", "Wild Cyclamen", "Clary Sage", "Marigold", "Saffron", "Immortelle", "Cassia", "Peach Blossom", "Cherry Blossom", "Apple Blossom", "Tiare Flower"],
            "Woody": ["Sandalwood", "Cedar", "Vetiver", "Patchouli", "Oud", "Agarwood", "Cypress", "Pine", "Fir", "Spruce", "Juniper", "Rosewood", "Guaiacwood", "Oak", "Birch", "Cashmere Wood", "Hinoki", "Teak", "Ebony", "Mahogany", "Bamboo", "Driftwood", "Tree Moss", "Oakmoss", "Virginian Cedar", "Atlas Cedar", "Texas Cedar", "Papyrus", "Clearwood", "Iso E Super"],
            "Citrus": ["Bergamot", "Lemon", "Lime", "Orange", "Grapefruit", "Mandarin", "Tangerine", "Yuzu", "Pomelo", "Citron", "Blood Orange", "Bitter Orange", "Petitgrain", "Lemongrass", "Lemon Verbena", "Neroli", "Orange Blossom", "Kumquat", "Clementine", "Calamansi"],
            "Fruit": ["Apple", "Peach", "Pear", "Plum", "Apricot", "Fig", "Cherry", "Strawberry", "Raspberry", "Blackberry", "Blueberry", "Blackcurrant", "Redcurrant", "Gooseberry", "Grape", "Melon", "Watermelon", "Mango", "Papaya", "Passionfruit", "Lychee", "Guava", "Pomegranate", "Persimmon", "Quince", "Coconut", "Date", "Banana", "Pineapple", "Kiwi"],
            "Greens": ["Green Tea", "Black Tea", "White Tea", "Oolong Tea", "Mate", "Mint", "Spearmint", "Peppermint", "Basil", "Sage", "Rosemary", "Thyme", "Tarragon", "Bay Leaf", "Eucalyptus", "Galbanum", "Violet Leaf", "Fig Leaf", "Tomato Leaf", "Blackcurrant Leaf", "Geranium Leaf", "Ivy", "Fern", "Grass", "Cut Grass", "Clover", "Artemisia", "Angelica", "Celery", "Rhubarb", "Cucumber", "Green Apple"],
            "Musks": ["White Musk", "Musk", "Amber", "Ambergris", "Cashmeran", "Galaxolide", "Muscone", "Civetone", "Musk Ketone", "Celestolide", "Habanolide", "Helvetolide", "Tonkin Musk", "Deer Musk", "Beeswax", "Honey Wax", "Milk", "Skin Musk"],
            "Warm Spices": ["Cinnamon", "Cardamom", "Clove", "Nutmeg", "Ginger", "Black Pepper", "Pink Pepper", "Sichuan Pepper", "Allspice", "Star Anise", "Coriander", "Cumin", "Saffron", "Turmeric", "Paprika", "Chili", "Fennel", "Caraway", "Juniper Berry", "Bay Leaf", "Tamarind"],
            "Synthetic": ["Ambroxan", "Iso E Super", "Hedione", "Calone", "Aldehyde", "Ozonic Notes", "Aquatic Notes", "Marine Notes", "Mineral Notes", "Metallic Notes", "Salty Notes", "Airy Notes", "Clean Notes", "Soapy Notes", "Powder Notes"],
            "Gourmand": ["Vanilla", "Tonka Bean", "Chocolate", "Caramel", "Coffee", "Cocoa", "Honey", "Praline", "Almond", "Hazelnut", "Pistachio", "Chestnut", "Marzipan", "Nougat", "Toffee", "Butterscotch", "Maple Syrup", "Condensed Milk", "Whipped Cream", "Custard", "Crème Brûlée", "Cotton Candy", "Marshmallow", "Licorice"],
            "Aquatic": ["Sea Water", "Ocean Breeze", "Seaweed", "Algae", "Sea Salt", "Driftwood", "Sand", "Mineral Water", "Rain", "Ozone", "Waterfall", "River Water"],
            "Resinous": ["Frankincense", "Myrrh", "Benzoin", "Labdanum", "Elemi", "Copal", "Styrax", "Balsam Fir", "Peru Balsam", "Tolu Balsam", "Gum Arabic", "Pine Resin", "Amber Resin"],
            "Boozy": ["Rum", "Whiskey", "Cognac", "Brandy", "Wine", "Champagne", "Sake", "Beer", "Absinthe", "Gin"],
            "Earthy": ["Soil", "Wet Earth", "Peat", "Mushroom", "Truffle", "Moss", "Lichen", "Tree Bark", "Dry Wood", "Volcanic Rock", "Clay"],
            "Animalic": ["Leather", "Suede", "Castoreum", "Civet", "Hyraceum", "Ambergris", "Musk (animalic)", "Hide", "Fur", "Horse Saddle"]
        };

        const familyColors = {
            "Floral": "bg-pink-100 text-pink-900 border-pink-200",
            "Woody": "bg-yellow-100 text-yellow-900 border-yellow-200",
            "Citrus": "bg-yellow-50 text-yellow-800 border-yellow-200",
            "Fruit": "bg-orange-100 text-orange-900 border-orange-200",
            "Greens": "bg-green-100 text-green-900 border-green-200",
            "Musks": "bg-purple-100 text-purple-900 border-purple-200",
            "Warm Spices": "bg-red-100 text-red-900 border-red-200",
            "Synthetic": "bg-blue-100 text-blue-900 border-blue-200",
            "Gourmand": "bg-yellow-50 text-yellow-900 border-yellow-300",
            "Aquatic": "bg-blue-100 text-blue-800 border-blue-200",
            "Resinous": "bg-amber-100 text-amber-900 border-amber-200",
            "Boozy": "bg-purple-50 text-purple-900 border-purple-200",
            "Earthy": "bg-stone-200 text-stone-900 border-stone-300",
            "Animalic": "bg-gray-200 text-gray-900 border-gray-300"
        };

        let currentMix = { top: [], heart: [], base: [] };
        let isMusicPlaying = true;
        let selectedNote = null;

        function init() {
            lucide.createIcons();
            renderSidebar();
            updateMusicIcon();
        }

        function enterWorld() {
            document.getElementById('splash-screen').classList.add('splash-hidden');
            const audio = document.getElementById('bg-music');
            audio.volume = 0.5;
            audio.play().catch(() => { isMusicPlaying = false; updateMusicIcon(); });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const container = document.getElementById('main-container');
            const icon = toggleBtn.querySelector('i');

            if (sidebar.classList.contains('closed')) {
                sidebar.classList.remove('closed');
                toggleBtn.classList.remove('closed-pos');
                toggleBtn.classList.add('open-pos');
                container.classList.remove('no-sidebar');
                container.classList.add('with-sidebar');
                icon.setAttribute('data-lucide', 'panel-left-close');
            } else {
                sidebar.classList.add('closed');
                toggleBtn.classList.remove('open-pos');
                toggleBtn.classList.add('closed-pos');
                container.classList.remove('with-sidebar');
                container.classList.add('no-sidebar');
                icon.setAttribute('data-lucide', 'panel-left-open');
            }
            lucide.createIcons();
        }

        function toggleFamily(header) {
            const content = header.nextElementSibling;
            const chevron = header.querySelector('.chevron');
            const isOpen = content.style.maxHeight;
            
            document.querySelectorAll('.family-content').forEach(c => c.style.maxHeight = null);
            document.querySelectorAll('.chevron').forEach(ch => ch.style.transform = '');
            document.querySelectorAll('.family-header').forEach(h => h.classList.remove('bg-white/50'));
            
            if (!isOpen) {
                content.style.maxHeight = content.scrollHeight + 'px';
                chevron.style.transform = 'rotate(180deg)';
                header.classList.add('bg-white/50');
            }
        }

        function renderSidebar() {
            const container = document.getElementById('notes-container');
            container.innerHTML = '';
            for (const [family, notes] of Object.entries(families)) {
                const item = document.createElement('div');
                item.className = 'overflow-hidden rounded-lg border border-white/40 mb-1';
                
                const header = document.createElement('div');
                header.className = 'family-header p-3 flex justify-between items-center cursor-pointer bg-white/20 hover:bg-white/40 transition-colors';
                header.onclick = () => toggleFamily(header);
                header.innerHTML = `<span class="text-[10px] font-bold text-gray-600 uppercase tracking-widest">${family}</span><i data-lucide="chevron-down" class="chevron w-3 h-3 text-gray-400 transition-transform duration-300"></i>`;
                
                const content = document.createElement('div');
                content.className = 'family-content bg-white/10 transition-all duration-300 ease-in-out';
                content.style.maxHeight = null;
                
                const grid = document.createElement('div');
                grid.className = 'p-3 flex flex-wrap gap-2';
                
                notes.forEach(note => {
                    const chip = document.createElement('div');
                    chip.className = `note-chip ${familyColors[family]}`;
                    chip.draggable = true;
                    chip.innerText = note;
                    chip.dataset.note = note;
                    chip.dataset.family = family;
                    chip.addEventListener('dragstart', drag);
                    chip.addEventListener('click', (e) => startSelection(e, note, family));
                    grid.appendChild(chip);
                });
                
                content.appendChild(grid);
                item.appendChild(header);
                item.appendChild(content);
                container.appendChild(item);
            }
            lucide.createIcons();
        }

        function drag(ev) {
            ev.dataTransfer.setData("note", ev.target.dataset.note);
            ev.dataTransfer.setData("family", ev.target.dataset.family);
        }
        function allowDrop(ev) {
            ev.preventDefault();
            const zone = ev.target.closest('.drop-zone');
            if(zone) zone.classList.add('drag-over');
        }
        document.addEventListener('dragend', () => document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over')));
        document.addEventListener('dragleave', (ev) => { if(ev.target.classList.contains('drop-zone')) ev.target.classList.remove('drag-over'); });
        
        function drop(ev, zoneName) {
            ev.preventDefault();
            document.getElementById(`zone-${zoneName}`).classList.remove('drag-over');
            const note = ev.dataTransfer.getData("note");
            const family = ev.dataTransfer.getData("family");
            addNote(zoneName, note, family);
        }

        function startSelection(e, note, family) {
            e.stopPropagation();
            selectedNote = { note, family };
            document.body.classList.add('mode-select');
        }
        function handleLayerClick(zoneName) {
            if (!selectedNote) return;
            addNote(zoneName, selectedNote.note, selectedNote.family);
            cancelSelection();
        }
        function cancelSelection() {
            selectedNote = null;
            document.body.classList.remove('mode-select');
        }

        function addNote(zoneName, noteName, familyName) {
            if (!noteName || currentMix[zoneName].find(n => n.name === noteName)) return;
            currentMix[zoneName].push({ name: noteName, family: familyName });
            const zone = document.getElementById(`zone-${zoneName}`);
            
            const chip = document.createElement('div');
            const colorClass = familyColors[familyName].split(' ')[1].replace('text', 'bg');
            chip.className = `note-chip flex items-center gap-2 bg-white shadow-sm animate-in fade-in zoom-in duration-200 border border-gray-200`;
            chip.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${colorClass}"></span>${noteName}<button class="text-gray-300 hover:text-red-400 ml-1 font-bold text-xs" onclick="removeNote(event, '${zoneName}', '${noteName}', this)">×</button>`;
            
            zone.querySelector('.empty-label').style.display = 'none';
            zone.appendChild(chip);
            calculateScene();
        }
        
        function removeNote(e, zoneName, noteName, btn) {
            e.stopPropagation();
            currentMix[zoneName] = currentMix[zoneName].filter(n => n.name !== noteName);
            btn.parentElement.remove();
            if (currentMix[zoneName].length === 0) document.getElementById(`zone-${zoneName}`).querySelector('.empty-label').style.display = 'block';
            calculateScene();
        }

        function resetPyramid() {
            currentMix = { top: [], heart: [], base: [] };
            ['top', 'heart', 'base'].forEach(z => {
                const el = document.getElementById(`zone-${z}`);
                el.innerHTML = `<span class="text-gray-300 text-[10px] font-bold uppercase tracking-wide empty-label pointer-events-none">${el.querySelector('.empty-label').innerText}</span>`;
            });
            calculateScene();
        }

        // --- ENHANCED MEMORY ENGINE ---
        function calculateScene() {
            const allNotes = [...currentMix.top, ...currentMix.heart, ...currentMix.base];
            const titleEl = document.getElementById('scene-title');
            const descEl = document.getElementById('scene-desc');
            const bgEl = document.getElementById('scene-bg');

            if (allNotes.length === 0) {
                titleEl.innerText = "The Void";
                descEl.innerText = "The air is still. The canvas is blank. Add a note to begin the memory.";
                bgEl.className = "absolute inset-0 opacity-30 bg-gradient-to-br from-gray-800 via-black to-gray-900 transition-all duration-1000";
                return;
            }

            const counts = {};
            allNotes.forEach(n => counts[n.family] = (counts[n.family] || 0) + 1);
            const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            const p = sorted[0], s = sorted[1] || p;

            const scenes = {
                "Floral": { 
                    title: "The Conservatory", 
                    text: "You step into a glass conservatory at twilight. Humidity clings to the air like silk. Night-blooming flowers release their narcotic perfume in waves, thick and intoxicating. Petals bruise beneath your fingertips, staining them with fragrant oils.", 
                    color: "from-pink-900 via-purple-900 to-black" 
                },
                "Woody": { 
                    title: "Ancient Library", 
                    text: "Mahogany shelves stretch into shadow. Dust motes dance in a single shaft of amber light. The room smells of aged paper, dry timber, and centuries of quiet contemplation. You run your hand along worn spines, feeling the weight of forgotten stories.", 
                    color: "from-amber-900 via-yellow-900 to-black" 
                },
                "Citrus": { 
                    title: "Amalfi Morning", 
                    text: "Brilliant white sunlight explodes over terra cotta tiles. The Mediterranean wind carries the sharp, electric scent of freshly torn citrus rinds and sea spray. Everything sparkles—the light, the air, the salt on your skin. Energy hums in every breath.", 
                    color: "from-yellow-600 via-orange-800 to-black" 
                },
                "Fruit": { 
                    title: "Summer Harvest", 
                    text: "A woven basket overflows with ripening fruit. The air is thick, sticky, and buzzing with lazy heat. Juice stains your fingers. Wasps circle overhead. The scent is almost too sweet, like childhood condensed into a single, perfect afternoon.", 
                    color: "from-orange-800 via-red-900 to-black" 
                },
                "Greens": { 
                    title: "Highland Storm", 
                    text: "You stand in a meadow just after rain. The earth is cold, wet, and alive. Crushed grass releases sharp, green aromas with every step. The wind cuts through you, carrying the scent of distant pines and wild herbs growing between rocks.", 
                    color: "from-green-900 via-teal-900 to-black" 
                },
                "Musks": { 
                    title: "Velvet Reverie", 
                    text: "A dimly lit room. Silk curtains pool on the floor. The atmosphere is intimate, warm, and hazy—like the scent of clean skin, soft cashmere, and sleep. You sink into something formless and comforting, losing track of time.", 
                    color: "from-purple-900 via-gray-900 to-black" 
                },
                "Warm Spices": { 
                    title: "The Spice Bazaar", 
                    text: "Golden light filters through cloth canopies. The air burns pleasantly with cinnamon, cardamom, and distant incense smoke. Clay walls radiate heat. Merchants speak in low voices. You taste the warmth on your tongue before you even breathe it in.", 
                    color: "from-red-900 via-orange-900 to-black" 
                },
                "Synthetic": { 
                    title: "Neon Rain", 
                    text: "A futuristic city reflects in wet pavement. The air smells of ozone, cold metal, and electricity. Blue light hums in the mist. Everything feels clean, sharp, and almost alien—like standing inside a machine that dreams.", 
                    color: "from-blue-900 via-indigo-900 to-black" 
                },
                "Gourmand": { 
                    title: "The Patisserie", 
                    text: "Warm butter and caramelized sugar fill a tiny Parisian bakery. Golden pastries cool on wire racks. The air is rich, sweet, and impossibly comforting—like being wrapped in a blanket made of childhood memories and Sunday mornings.", 
                    color: "from-yellow-900 via-orange-900 to-black" 
                },
                "Aquatic": { 
                    title: "Coastal Dawn", 
                    text: "You wake on a deserted beach. The tide has just retreated, leaving behind wet sand and scattered shells. Salt crusts your skin. Seaweed and mineral-rich water perfume the cold, misty air. The world feels newborn and ancient at once.", 
                    color: "from-blue-900 via-cyan-900 to-black" 
                },
                "Resinous": { 
                    title: "Sacred Temple", 
                    text: "Frankincense smoke curls toward a vaulted ceiling. Amber resin glows in brass censers. The space feels ancient, reverent, and thick with devotion. Stone walls hold the prayers of centuries. Time moves differently here.", 
                    color: "from-amber-900 via-orange-900 to-black" 
                },
                "Boozy": { 
                    title: "The Cellar", 
                    text: "Oak barrels line damp stone walls. The air is cool, dark, and redolent with aged spirits—whiskey, rum, wine. A single candle flickers. The scent is intoxicating, loosening memory and time until both blur into golden warmth.", 
                    color: "from-purple-900 via-red-900 to-black" 
                },
                "Earthy": { 
                    title: "Forest Floor", 
                    text: "You kneel on damp soil. Mushrooms push through rotting leaves. The scent is primal, organic, and grounding—life returning to earth, death feeding new growth. Your hands sink into soft moss. You feel rooted, ancient, alive.", 
                    color: "from-green-900 via-gray-900 to-black" 
                },
                "Animalic": { 
                    title: "The Stable", 
                    text: "Worn leather saddles hang on hooks. Hay rustles in the loft above. The air is warm, musky, and alive with the scent of hide, horse, and hard work. It smells raw, honest, and deeply human—like sweat and effort and survival.", 
                    color: "from-gray-900 via-stone-900 to-black" 
                }
            };

            const atmos = {
                "Floral": "A soft, romantic sweetness softens every sharp edge, wrapping you in velvet.",
                "Woody": "Deep, grounding shadows anchor the memory, pulling you down into stillness.",
                "Citrus": "Bright, sparkling energy cuts through like morning light on broken glass.",
                "Fruit": "Playful, mouth-watering juiciness adds unexpected joy, like laughter in the rain.",
                "Greens": "Sharp, botanical freshness makes the air feel cold, alive, and impossibly clean.",
                "Musks": "A hazy, dreamlike fog wraps around you like a second skin, warm and familiar.",
                "Warm Spices": "Glowing amber warmth radiates from the center, like a hearth in winter.",
                "Synthetic": "A strange, modern vibration hums just beneath the surface, electric and alien.",
                "Gourmand": "A golden, bakery warmth makes you feel safe, nostalgic, and impossibly loved.",
                "Aquatic": "The distant crash of waves echoes in your bones, pulling you toward the horizon.",
                "Resinous": "Sacred smoke adds weight and gravitas, turning the mundane into ritual.",
                "Boozy": "Intoxicating fumes swirl around you, loosening memory and loosening time.",
                "Earthy": "Primal, organic decay grounds you in the present, undeniable and real.",
                "Animalic": "Raw, musky warmth reminds you of living things—breathing, sweating, surviving."
            };

            const names = allNotes.map(n => n.name);
            let ex = [];
            if(names.includes("Oud") || names.includes("Agarwood")) ex.push("Sacred smoke curls lazily upward, carrying prayers you never spoke.");
            if(names.includes("Vanilla")) ex.push("A golden, creamy sweetness soothes your soul like a lullaby.");
            if(names.includes("Leather") || names.includes("Suede")) ex.push("You sink into a well-worn leather chair, feeling its history.");
            if(names.includes("Sea Water") || names.includes("Sea Salt")) ex.push("The scent of brine clings to your clothes, your hair, your memory.");
            if(names.includes("Fig")) ex.push("Milky sap from crushed fruit stains your hands, sticky and sweet.");
            if(names.includes("Yuzu")) ex.push("An exotic, sparkling zest awakens senses you forgot you had.");
            if(names.includes("Coffee")) ex.push("The bitter-sweet aroma of espresso lingers, sharp and clarifying.");
            if(names.includes("Tobacco")) ex.push("Dry tobacco leaves rest in a leather pouch, earthy and contemplative.");
            if(names.includes("Iris")) ex.push("A powdery, aristocratic elegance lifts the scene into something refined.");
            if(names.includes("Patchouli")) ex.push("Dark, earthy patchouli roots you to the ground like ancient trees.");
            if(names.includes("Honey")) ex.push("Golden honey drips slowly, catching the light, impossibly rich.");
            if(names.includes("Incense")) ex.push("Coils of incense smoke spiral upward, marking time in fragrant rings.");

            let fTitle = scenes[p].title;
            let fText = scenes[p].text + " " + atmos[s];
            if(ex.length > 0) fText += " " + ex.slice(0, 2).join(" ");

            if(p === "Floral" && s === "Woody") fTitle = "The Enchanted Woods";
            if(p === "Citrus" && s === "Synthetic") fTitle = "Cyberpunk Soda";
            if(p === "Musks" && s === "Warm Spices") fTitle = "Cashmere Embrace";
            if(p === "Greens" && s === "Floral") fTitle = "Monet's Garden";
            if(p === "Aquatic" && s === "Citrus") fTitle = "Mediterranean Breeze";
            if(p === "Woody" && s === "Resinous") fTitle = "Cathedral of Trees";
            if(p === "Gourmand" && s === "Warm Spices") fTitle = "Chai & Nostalgia";

            titleEl.innerText = fTitle;
            descEl.innerText = fText;
            bgEl.className = `absolute inset-0 opacity-40 bg-gradient-to-br ${scenes[p].color} transition-all duration-1000`;
        }

        function toggleMusic() {
            const audio = document.getElementById('bg-music');
            const strike = document.getElementById('music-strike');
            if (isMusicPlaying) {
                audio.pause();
                isMusicPlaying = false;
                strike.classList.add('hidden');
            } else {
                audio.play();
                isMusicPlaying = true;
                strike.classList.remove('hidden');
            }
        }
        
        function updateMusicIcon() {
            const strike = document.getElementById('music-strike');
            if (isMusicPlaying) strike.classList.remove('hidden');
            else strike.classList.add('hidden');
        }

        init();
    </script>
</body>
</html>